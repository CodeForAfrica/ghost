# This file should live in `/etc/nginx/conf.d/` or wherever your preferred flavour of Nginx expects to find config files.
#
# The central idea of this Nginx conf file is converting URLs containing non-ASCII characters into a format that Ghost understands
# and doing the corresponding redirects. This is necessitated by the fact that Ghost has zero i18n support for URLs and slugs.
#
# Why do all this? So that we can handle legacy Medium URLs seamlessly.
#
# This means if a user visits
# https://pesacheck.org/partiellement-faux-le-gouvernement-sénégalais-na-pas-été-dissout-après-les-manifestations-du-19-edabf04ab1df
# They get transparently redirected to
# https://pesacheck.org/partiellement-faux-le-gouvernement-s-c3-a9n-c3-a9galais-na-pas--c3-a9t-c3-a9-dissout-apr-c3-a8s-les-manifestations-du-19
# Which is the URL of the post within Ghost
#
# Example conversions:
#
# French
# partiellement-faux-le-gouvernement-sénégalais-na-pas-été-dissout-après-les-manifestations-du-19 ->
# partiellement-faux-le-gouvernement-s-c3-a9n-c3-a9galais-na-pas--c3-a9t-c3-a9-dissout-apr-c3-a8s-les-manifestations-du-19
#
# Amharic
# የፈጠራ-ወሬ-የየመን-ሚሳኤል-በእስራኤል-ላይ-ያደረሰውን-ጥቃት-ያሳይሉ-የተባሉት-እነዚህ-ሁለት-ፎቶዎች-የተቀነባበሩ-ናቸውi ->
# -e1-8b-a8-e1-8d-88-e1-8c-a0-e1-88-ab--e1-8b-88-e1-88-ac--e1-8b-a8-e1-8b-a8-e1-88-98-e1-8a-95--e1-88-9a-e1-88-b3-e1-8a-a4-e1-88-8d--e1-89-a0-e1-8a-a5-e1-88-b5-e1-88-ab-e1-8a-a4-e1-88-8d-
#
# English
# false-ugandas-education-minister-janet-museveni-has-not-ordered-schools-to-end-their-third-term ->
# false-ugandas-education-minister-janet-museveni-has-not-ordered-schools-to-end-their-third-term (No change as expected)
#


# Determine if the URL needs conversion by checking if it contains non-ASCII characters.
map $uri $needs_conversion {
    ~[^\x00-\x7F] "yes";
    default        "no";
}

server {
    listen 8069;
    server_name localhost;

    client_max_body_size 100M;

    # Remove the random ID that Medium appends to post URLs. This effectively does the same redirect recommended by Ghost here:
    # https://docs.ghost.org/migration/medium#using-custom-domains
    rewrite "^/(.*)(-[0-9a-f]{10,12})$" /$1 permanent;

    location / {
        # Check if conversion is needed using the map
        access_by_lua_block {
            if ngx.var.needs_conversion == "yes" then
              local function convert_string(input_str)
                  -- Split the input string by hyphens
                  local parts = {}
                  for part in string.gmatch(input_str, "([^%-]+)") do
                      table.insert(parts, part)
                  end

                  -- Process each part (same as above)
                  local encoded_parts = {}
                  for i, part in ipairs(parts) do
                      -- Convert part to UTF-8 byte sequence and encode
                      local encoded = ""
                      for j = 1, #part do
                          local byte = string.byte(part, j)
                          if byte < 128 and string.match(string.char(byte), "[%w%-_.~]") then
                              -- Keep safe ASCII characters as is
                              encoded = encoded .. string.char(byte)
                          else
                              -- For all other bytes, use the -XX format
                              encoded = encoded .. "-" .. string.format("%02x", byte):lower()
                          end
                      end
                      table.insert(encoded_parts, encoded)
                  end

                  -- Join all parts back with hyphens
                  local result = table.concat(encoded_parts, "-")

                  -- Truncate the URL at 185 characters in case it is longer to match what Ghost expects
                  if #result > 185 then
                      result = string.sub(result, 1, 185)
                  end

                  return result
              end

                  -- Remove leading slash for processing
                  local original_path = ngx.var.uri
                  if string.sub(original_path, 1, 1) == "/" then
                      original_path = string.sub(original_path, 2, -1)
                  end

                  local converted_path = convert_string(original_path)

                  -- Redirect to the converted path
                  ngx.redirect("/" .. converted_path, 301)
                  return
            end
        }

        # Handle normal requests that don't need conversion
        proxy_pass http://ghost:2368;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
